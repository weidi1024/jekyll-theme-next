---
title: 实验室电脑安装Ubuntu18.04 caffe tensorflow等
date: 2019-07-16 22:00:00
categories: 实验室
tags: 实验室 ubuntu
mathjax: true

---
*ubuntu 安装系统记录*
---

# 电脑硬件

> DELL-PRECSION TOWER 7910
>
> Intel Xeon(R) CPU E5-2630 v4 @ 2.20GHz × 20 
>
> GeForce GTX 1080 Ti
>
> 128 GB
>
> 2 TB + 256 GB

# 安装系统
下载ubuntu1804系统安装包，地址
利用U盘制作启动盘
插入电脑，开机按F12进入启动项选择
选择U盘，进行安装
此处网上教程很多，不在赘述


# apt换源
打开软件和更新
ubuntu软件-下载自-进入修改为国内的地址，比如aliyun的
关闭并更新
升级软件（可选）

	sudo apt-get update
	sudo apt-get upgrade


# pip
## 安装pip
pip是python包的管理

	sudo apt-get install python-pip python-dev build-essential
	pip install --upgrade pip
	
## pip换源
默认的源服务器在国外，国内访问太慢，修改为国内的服务器访问起来较快。
修改 ~/.pip/pip.conf (没有就创建一个)， 如下：

	mkdir ~/.pip/
	geidt ~/.pip/pip.conf
	
输入如下内容并保存

	[global]
	index-url = https://mirrors.aliyun.com/pypi/simple/
	
pip换源之后速度真的是非常舒爽...


# 安装显卡驱动430.34
安装依赖项

	sudo apt-get install dkms build-essential linux-headers-generic apt-show-versions
	
禁用nouveau

	sudo gedit /etc/modprobe.d/blacklist.conf
	
在最后一行加入

	blacklist nouveau
	blacklist lbm-nouveau
	options nouveau modeset=0
	alias nouveau off
	alias lbm-nouveau off
	
保存，并执行如下命令

	echo options nouveau modeset=0 | sudo tee -a /etc/modprobe.d/nouveau-kms.conf
	sudo update-initramfs -u
	
重启，开机后执行：

	sudo ./NVIDIA-Linux-*.run
	
遇到要选择的地方，都是默认选择
安装完成后执行

	nvidia-smi
	
(查看nvidia信息）
出现如下信息就说明安装成功了


# 安装相关依赖项

	sudo apt-get install libprotobuf-dev libleveldb-dev libsnappy-dev libopencv-dev libhdf5-serial-dev protobuf-compiler libboost-all-dev libopenblas-dev liblapack-dev libatlas-base-dev libgflags-dev libgoogle-glog-dev liblmdb-dev

# 安装cuda10.0

	sudo ./runpackage/cuda_9.0.176_384.81_linux.run
	
Ctrl C退出条款页面，输入accept
除了询问是否安装显卡驱动的时候选择NO,其他都是选择Yes或者默认。
安装完成后需要设置环境变量和动态链接库
执行

	sudo gedit ~/.bashrc
	
写入

	export PATH=/usr/local/cuda/bin${PATH:+:${PATH}}
	export LD_LIBRARY_PATH=/usr/local/cuda/lib64${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}
	export CUDA_HOME=/usr/local/cuda
	
执行

	sudo gedit /etc/profile

写入

	export PATH=/usr/local/cuda/bin:$PATH
	
执行

	sudo gedit /etc/ld.so.conf.d/cuda.conf
	
写入

	/usr/local/cuda/lib64

执行

	sudo ldconfig
	
然后重新启动

	reboot
	
重启后执行检查

	nvcc --version
	
测试一下看看cuda是否安装成功

	cd /home/weidi/NVIDIA_CUDA-9.0_Samples/1_Utilities/deviceQuery 
	sudo make -j4
	./deviceQuery
	
最后一行PASS即可


# 安装cudnn7.4
解压后进入cuda文件夹

	sudo cp include/cudnn.h /usr/local/cuda/include
	sudo cp lib64/libcudnn* /usr/local/cuda/lib64
	sudo chmod a+r /usr/local/cuda/include/cudnn.h /usr/local/cuda/lib64/libcudnn*
	
对，直接拷贝过去就可以了


# 安装相关依赖项

	sudo apt-get install build-essential cmake git libgtk2.0-dev pkg-config libavcodec-dev libavformat-dev libswscale-dev python-dev python-numpy libtbb2 libtbb-dev libjpeg-dev libtiff5-dev libdc1394-22-dev libatlas-base-dev gfortran



# 安装openblas

	sudo apt-get install libopenblas-dev
	sudo apt-get install libopenblas-base
	
可以到 https://github.com/xianyi/OpenBLAS/releases 下载你喜欢的版本解压到指定目录，也可以直接git clone
下载后进入文件夹

	cd OpenBLAS
	make -j10
	sudo make --PREFIX=/usr/local/OpenBLAS/ install

测试OpenBLAS

	gedit ./test.c
	
输入如下内容

	gcc ./test.c  -I /usr/local/OpenBLAS/include/ -L /usr/local/OpenBLAS/lib -lopenblas
	
会在当前文件夹下生成可执行文件　a.out

	a.out
	
结果如下

> 0.000000 1.000000 2.000000 3.000000 4.000000 5.000000 6.000000 7.000000 8.000000 9.000000 
>
> 90.000000 81.000000 72.000000 63.000000 54.000000 45.000000 36.000000 27.000000 18.000000 9.000000







# 安装caffe-ssd
下载caffe-ssd源码
下载caffe源码
修改makeconfig，文件就在当前目录下，直接将当前目录下的拷贝到caffe-ssd中即可
将caffe中关于cudnn的文件全部拷贝到caffe-ssd中，因为caffe-ssd中的版本太老，直接安装会出错。
查看opencv版本:

	pkg-config opencv --modversion


编译

	sudo make all -j20
	sudo make test -j20
	sudo make runtest -j20
	sudo make pycaffe -j20

## 错误１

	collect2: error: ld returned 1 exit status
	.build_release/lib/libcaffe.so：对‘cv::VideoWriter::isOpened() const’未定义的引用
	collect2: error: ld returned 1 exit status
	Makefile:619: recipe for target '.build_release/tools/convert_annoset.bin' failed
	make: *** [.build_release/tools/convert_annoset.bin] Error 1
	Makefile:624: recipe for target '.build_release/examples/siamese/convert_mnist_siamese_data.bin' failed
	make: *** [.build_release/examples/siamese/convert_mnist_siamese_data.bin] Error 1

解决：
首先这个问题确实是opencv的问题，只需要把  Makefile.config里的#USE_PKG_CONFIG := 这一行前面的#给去掉，然后在他下一行添加
LIBRARIES += glog gflags protobuf leveldb snappy \
        lmdb boost_system hdf5_hl hdf5 m \
        opencv_core opencv_highgui opencv_imgproc opencv_imgcodecs
原文：https://blog.csdn.net/yuweiyang123/article/details/53106638 

## 警告２
In file included from src/caffe/util/math_functions.cu:1:0:
/usr/local/cuda/include/math_functions.h:54:2: warning: #warning "math_functions.h is an internal header file and must not be used directly.  This file will be removed in a future CUDA release.  Please use cuda_runtime_api.h or cuda_runtime.h instead." [-Wcpp]
 #warning "math_functions.h is an internal header file and must not be used directly.  This file will be removed in a future CUDA release.  Please use cuda_runtime_api.h or cuda_runtime.h instead."
	【解决２】
修改头文件即可


## 错误３

	1 Check failed: a <= b <0 vs -1.19209e-007>

解决：
https://blog.csdn.net/LuohenYJ/article/details/88416180
解决办法修改src/caffe/util/sampler.cpp，如下面修改代码所示//renew注释下，加入两个判断，使得bbox长宽不要越界。
  // Figure out bbox dimension.
  float bbox_width = scale * sqrt(aspect_ratio);
  float bbox_height = scale / sqrt(aspect_ratio);

  //renew
  if(bbox_width>=1.0)
  {
    bbox_width=1.0;
  }
  if(bbox_height>=1.0)
  {
    bbox_height=1.0;
  }



## 错误４
./include/caffe/util/cudnn.hpp:21:10: warning: enumeration value ‘CUDNN_STATUS_RUNTIME_FP_OVERFLOW’ not handled in switch [-Wswitch]
CXX src/caffe/layers/cudnn_sigmoid_layer.cpp
In file included from ./include/caffe/util/device_alternate.hpp:40:0,
                 from ./include/caffe/common.hpp:19,
                 from ./include/caffe/blob.hpp:8,
                 from ./include/caffe/layers/silence_layer.hpp:6,
                 from src/caffe/layers/silence_layer.cpp:3:
解决：
 作者发布的源码中caffe的版本较低，下载最新的caffe，将相关源码覆盖掉ssd中的


## 错误５
CXX/LD -o .build_release/tools/convert_imageset.bin
//usr/lib/x86_64-linux-gnu/libblas.so.3：对‘gotoblas’未定义的引用
collect2: error: ld returned 1 exit status
Makefile:619: recipe for target '.build_release/tools/upgrade_solver_proto_text.bin' failed
make: *** [.build_release/tools/upgrade_solver_proto_text.bin] Error 1
make: *** 正在等待未完成的任务....
//usr/lib/x86_64-linux-gnu/libblas.so.3：对‘gotoblas’未定义的引用

解决：

	sudo apt-get install libopenblas-dev
	sudo apt-get install libopenblas-base

在makefile.config中加入路径/usr/lib/x86_64-linux-gnu/，具体如下

	INCLUDE_DIRS := $(PYTHON_INCLUDE) /usr/local/include /usr/lib/x86_64-linux-gnu/hdf5/serial/include /usr/lib/x86_64-linux-gnu/
	LIBRARY_DIRS := $(PYTHON_LIB) /usr/local/lib /usr/lib /usr/lib/x86_64-linux-gnu/hdf5/serial /usr/lib/x86_64-linux-gnu/


以下安装不分先后
# 安装tensorflow1.13.1

	pip install tensorflow1.13.1

[tensorflow 1.13 need cuda10.0 cudnn7.4]

# 安装mxnet
由于我安装的是cuda10.0，因此使用如下命令安装

	pip install mxnet-cu100


# 安装wps
去官网下载deb格式的安装包，下载后直接双击deb安装包，进入软件管理器自动安装。
安装后报错，系统缺失字体。
解决方法https://www.cnblogs.com/dinphy/p/5888546.html



# 安装matlab2017b
## 安装

	sudo mkdir /media/matlab
	sudo mount -o loop ./R2017b_glnxa64_dvd1.iso /media/matlab
	sudo /media/matlab/install

- Install choosing the option "Use a File Installation Key" and supply the following FIK
先退出第一个盘

	sudo mount -o loop ./R2017b_glnxa64_dvd2.iso /media/matlab

## 激活

	cd /usr/local/MATLAB/R2016b/bin
	sudo ./matlab

进入crack下R2017b/bin/glnxa64拷贝文件

	sudo cp license_standalone.lic /usr/local/MATLAB/R2017b/licenses/
	sudo cp libmwservices.so /usr/local/MATLAB/R2017b/bin/glnxa64/

## 任意位置终端打开matlab
在目录/usr/local/bin里面创建一个指向Matlab安装目录/usr/local/MATLAB/R2017b/bin的符号链接：（非默认安装需替换安装路径）

	sudo ln -s /usr/local/MATLAB/R2017b/bin/matlab /usr/local/bin/matlab

现在在任何位置都可以打开MATLAB

	matlab


## 其他

如果出现权限问题，执行如下命令

	sudo chmod a+w -R ~/.matlab

